name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Build with Gradle
      run: |
        chmod +x ./gradlew
        ./gradlew build
        
    - name: Build JAR
      run: |
        ./gradlew jar
        
    - name: Download Launch4j
      run: |
        Invoke-WebRequest -Uri "https://sourceforge.net/projects/launch4j/files/launch4j-3/3.14/launch4j-3.14-win32.zip/download" -OutFile "launch4j.zip"
        Expand-Archive -Path "launch4j.zip" -DestinationPath "."
      
    - name: Create Launch4j config
      run: |
        $content = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <launch4jConfig>
          <dontWrapJar>false</dontWrapJar>
          <headerType>gui</headerType>
          <jar>build/libs/File-encryption-anaylsis.jar</jar>
          <outfile>build/exe/File-encryption-anaylsis.exe</outfile>
          <errTitle>File Encryption Analysis</errTitle>
          <chdir>.</chdir>
          <priority>normal</priority>
          <downloadUrl>https://adoptopenjdk.net/</downloadUrl>
          <supportUrl></supportUrl>
          <stayAlive>false</stayAlive>
          <restartOnCrash>false</restartOnCrash>
          <manifest></manifest>
          <icon>src/main/resources/File Encryption Analysis.ico</icon>
          <jre>
            <path></path>
            <bundledJre64Bit>false</bundledJre64Bit>
            <minVersion>11</minVersion>
            <maxVersion></maxVersion>
            <jdkPreference>preferJre</jdkPreference>
            <runtimeBits>64/32</runtimeBits>
          </jre>
        </launch4jConfig>
        "@
        New-Item -Path "launch4j-config.xml" -ItemType "file" -Value $content
      shell: pwsh
      
    - name: Create EXE with Launch4j
      run: |
        launch4j/launch4j.exe launch4j-config.xml

    - name: Create Output Directory
      run: mkdir -p release

    - name: Copy Build Artifacts
      run: |
        cp build/libs/File-encryption-anaylsis.jar release/
        cp build/exe/File-encryption-anaylsis.exe release/
      
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: file-encryption-analysis-builds
        path: |
          release/File-encryption-anaylsis.jar
          release/File-encryption-anaylsis.exe
